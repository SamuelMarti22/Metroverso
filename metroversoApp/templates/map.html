{% load static %}
<!DOCTYPE html>
<html>

<head>


    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">

    <!--MapBox imports-->
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.13.0/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.13.0/mapbox-gl.js"></script>

    <!--Turf import-->
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>


    <!--CSS/style imports-->
    <link rel="stylesheet" href="{% static 'css/Stylemap.css' %}">

    <!--JS/js-->
    <script src="{% static 'js/dataTurf.js' %}" onload="console.log('dataTurf cargado');"></script>
    <script src="{% static 'js/functions.js' %}" onload="console.log('functions cargado');"></script>

    <!-- Bootstrap JS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>


</head>

<body>

    <!--Map Container-->
    <div id="map"></div>


    <!-- Sidebar -->
    <div class="sidebar">
        <div class="icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="35" height="35" fill="#008f37"
                class="bi bi-sign-railroad-fill" viewBox="0 0 16 16">
                <path
                    d="M9.05.435c-.58-.58-1.52-.58-2.1 0L4.224 3.162 8 6.94l3.777-3.777L9.049.435Zm3.274 7.425v-.862h.467c.28 0 .467.154.467.44 0 .28-.182.421-.475.421h-.459Z" />
                <path
                    d="M12.838 4.223 9.06 8l3.777 3.777 2.727-2.728c.58-.58.58-1.519 0-2.098zm.03 2.361c.591 0 .935.334.935.844a.79.79 0 0 1-.485.748l.536 1.074h-.59l-.467-.994h-.473v.994h-.521V6.584h1.064Zm-1.091 6.254L8 9.06l-3.777 3.777 2.728 2.727c.58.58 1.519.58 2.098 0zm-8.953-5.84v.861h.46c.292 0 .474-.14.474-.421 0-.286-.188-.44-.467-.44z" />
                <path
                    d="M3.162 11.777 6.94 8 3.162 4.223.435 6.951c-.58.58-.58 1.519 0 2.098zm-.86-5.193h1.065c.592 0 .936.334.936.844 0 .39-.242.654-.485.748l.536 1.074h-.59l-.467-.994h-.473v.994h-.521V6.584Z" />
            </svg>
        </div>

        <div class="subCategory" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasScrolling"
            aria-controls="offcanvasScrolling">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                class="bi bi-compass-fill" viewBox="0 0 16 16">
                <path
                    d="M15.5 8.516a7.5 7.5 0 1 1-9.462-7.24A1 1 0 0 1 7 0h2a1 1 0 0 1 .962 1.276 7.5 7.5 0 0 1 5.538 7.24m-3.61-3.905L6.94 7.439 4.11 12.39l4.95-2.828 2.828-4.95z" />
            </svg>
        </div>

        <div class="subCategory">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                class="bi bi-signpost-2-fill" viewBox="0 0 16 16">
                <path
                    d="M7.293.707A1 1 0 0 0 7 1.414V2H2a1 1 0 0 0-1 1v2a1 1 0 0 0 1 1h5v1H2.5a1 1 0 0 0-.8.4L.725 8.7a.5.5 0 0 0 0 .6l.975 1.3a1 1 0 0 0 .8.4H7v5h2v-5h5a1 1 0 0 0 1-1V8a1 1 0 0 0-1-1H9V6h4.5a1 1 0 0 0 .8-.4l.975-1.3a.5.5 0 0 0 0-.6L14.3 2.4a1 1 0 0 0-.8-.4H9v-.586A1 1 0 0 0 7.293.707" />
            </svg>
        </div>

        <div class="subCategory">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-radar"
                viewBox="0 0 16 16">
                <path
                    d="M6.634 1.135A7 7 0 0 1 15 8a.5.5 0 0 1-1 0 6 6 0 1 0-6.5 5.98v-1.005A5 5 0 1 1 13 8a.5.5 0 0 1-1 0 4 4 0 1 0-4.5 3.969v-1.011A2.999 2.999 0 1 1 11 8a.5.5 0 0 1-1 0 2 2 0 1 0-2.5 1.936v-1.07a1 1 0 1 1 1 0V15.5a.5.5 0 0 1-1 0v-.518a7 7 0 0 1-.866-13.847" />
            </svg>
        </div>

        <div class="subCategory" style="margin-top: 460px;">
            <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" fill="currentColor" class="bi bi-alipay"
                viewBox="0 0 16 16">
                <path
                    d="M2.541 0H13.5a2.55 2.55 0 0 1 2.54 2.563v8.297c-.006 0-.531-.046-2.978-.813-.412-.14-.916-.327-1.479-.536q-.456-.17-.957-.353a13 13 0 0 0 1.325-3.373H8.822V4.649h3.831v-.634h-3.83V2.121H7.26c-.274 0-.274.273-.274.273v1.621H3.11v.634h3.875v1.136h-3.2v.634H9.99c-.227.789-.532 1.53-.894 2.202-2.013-.67-4.161-1.212-5.51-.878-.864.214-1.42.597-1.746.998-1.499 1.84-.424 4.633 2.741 4.633 1.872 0 3.675-1.053 5.072-2.787 2.08 1.008 6.37 2.738 6.387 2.745v.105A2.55 2.55 0 0 1 13.5 16H2.541A2.55 2.55 0 0 1 0 13.437V2.563A2.55 2.55 0 0 1 2.541 0" />
                <path
                    d="M2.309 9.27c-1.22 1.073-.49 3.034 1.978 3.034 1.434 0 2.868-.925 3.994-2.406-1.602-.789-2.959-1.353-4.425-1.207-.397.04-1.14.217-1.547.58Z" />
            </svg>
        </div>

        <div class="profileIcon"></div>
    </div>

    <!-- Offcanvas Panel -->
    <div class="offcanvasContainer">
        <div class="offcanvas offcanvas-start" data-bs-scroll="true" data-bs-backdrop="false" tabindex="-1"
            id="offcanvasScrolling" aria-labelledby="offcanvasScrollingLabel">
            <div class="offcanvas-header">
                <h5 class="offcanvas-title" id="offcanvasScrollingLabel">Offcanvas with body scrolling</h5>
                <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
            </div>
            <div class="offcanvas-body">
                <!--Interactive Botton Rute-->
                <div class="divRute">
                    <input type="text" id="inputStart" placeholder="Inicio">
                    <input type="text" id="inputDestination" placeholder="Destino">
                    <button id="btnSearchRute">Buscar l√≠neas</button>
                </div>
            </div>
        </div>
    </div>

    <!-- User Location Button -->
    <div class="userLocation1" id="btnUserLocationOrigin">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-person-arms-up"
            viewBox="0 0 16 16">
            <path d="M8 3a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3" />
            <path
                d="m5.93 6.704-.846 8.451a.768.768 0 0 0 1.523.203l.81-4.865a.59.59 0 0 1 1.165 0l.81 4.865a.768.768 0 0 0 1.523-.203l-.845-8.451A1.5 1.5 0 0 1 10.5 5.5L13 2.284a.796.796 0 0 0-1.239-.998L9.634 3.84a.7.7 0 0 1-.33.235c-.23.074-.665.176-1.304.176-.64 0-1.074-.102-1.305-.176a.7.7 0 0 1-.329-.235L4.239 1.286a.796.796 0 0 0-1.24.998l2.5 3.216c.317.316.475.758.43 1.204Z" />
        </svg>
    </div>
    <div class="userLocation" id="btnUserLocationDestiny">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-person-arms-up"
            viewBox="0 0 16 16">
            <path d="M8 3a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3" />
            <path
                d="m5.93 6.704-.846 8.451a.768.768 0 0 0 1.523.203l.81-4.865a.59.59 0 0 1 1.165 0l.81 4.865a.768.768 0 0 0 1.523-.203l-.845-8.451A1.5 1.5 0 0 1 10.5 5.5L13 2.284a.796.796 0 0 0-1.239-.998L9.634 3.84a.7.7 0 0 1-.33.235c-.23.074-.665.176-1.304.176-.64 0-1.074-.102-1.305-.176a.7.7 0 0 1-.329-.235L4.239 1.286a.796.796 0 0 0-1.24.998l2.5 3.216c.317.316.475.758.43 1.204Z" />
        </svg>
    </div>

    <script>
        mapboxgl.accessToken = 'pk.eyJ1IjoibGFjYXRyaWxmIiwiYSI6ImNtZG00eGJqZjAxMGYyaXBrcGY3b2tjYzIifQ.gx3C4J17a-6YrUBt6sZTmQ';

        const initialLocationView = [-75.5752, 6.2491]; // Coordinates of San Antonio

        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/standard', // Style of the map
            config: {
                basemap: {
                    theme: 'monochrome'
                }
            },
            center: initialLocationView,
            zoom: 15
        });

        // Function to find the closest points
        console.log("Map initialized");
        map.on('load', () => {
            userPoint = turf.point([-75.585684, 6.191629]);
            const top3 = closestPoints(userPoint, 2000);
            console.log("Nodes:" + top3);

            new mapboxgl.Marker({ color: "blue" })
                .setLngLat(userPoint.geometry.coordinates)
                .addTo(map);

            const pointsGeoJSON = {
                "type": "FeatureCollection",
                "features": top3.map(p => ({
                    "type": "Feature",
                    "geometry": p.geometry,
                    "properties": {
                        "ID": p.properties.ID,
                    }
                }))
            };


            const linesGeoJSON = {
                "type": "FeatureCollection",
                "features": top3.map(p => {

                    const distance = turf.distance(userPoint, p, { units: 'meters' });

                    return {
                        "type": "Feature",
                        "geometry": {
                            "type": "LineString",
                            "coordinates": [
                                userPoint.geometry.coordinates,
                                p.geometry.coordinates
                            ]
                        },
                        "properties": {
                            "distance": `${distance.toFixed(0)} m`  // redondeamos a metros
                        }
                    };
                })
            };


            map.addSource('points', { "type": "geojson", "data": pointsGeoJSON });
            map.addSource('lines', { "type": "geojson", "data": linesGeoJSON });


            map.addLayer({
                "id": "lines-layer",
                "type": "line",
                "source": "lines",
                "layout": {
                    "line-join": "round",
                    "line-cap": "round"
                },
                "paint": {
                    "line-color": "#FF0000",
                    "line-width": 2
                }
            });


            map.addLayer({
                "id": "points-layer",
                "type": "circle",
                "source": "points",
                "paint": {
                    "circle-color": "#FF0000",
                    "circle-radius": 6,
                    "circle-stroke-width": 2,
                    "circle-stroke-color": "#FFFFFF"
                }
            });


            map.addLayer({
                "id": "distance-labels",
                "type": "symbol",
                "source": "lines",
                "layout": {
                    "symbol-placement": "line",
                    "text-field": ["get", "distance"],
                    "text-size": 14,
                    "text-offset": [0, 0.5]
                },
                "paint": {
                    "text-color": "#000000",
                    "text-halo-color": "#FFFFFF",
                    "text-halo-width": 1
                }
            });
        });

        map.on('click', 'points-layer', (e) => {
            const feature = e.features[0];


            new mapboxgl.Popup()
                .setLngLat(feature.geometry.coordinates)
                .setHTML(`
            <b>ID:</b> ${feature.properties.ID || 'Sin ID'}<br>
            <b>Distance:</b> ${feature.properties.distance || 'N/A'}
        `)
                .addTo(map);
        });

        // End closest points function

        // Rute finding function
        document.getElementById('btnSearchRute').addEventListener('click', function () {
            const inputStart = document.getElementById('inputStart').value;
            const inputDestination = document.getElementById('inputDestination').value;

            console.log(`Inicio: ${inputStart}, Destino: ${inputDestination}`);

            fetch(`/view/callRute?inputStart=${inputStart}&inputDestination=${inputDestination}`)
                .then(res => res.json())
                .then(data => {
                    console.log(data.rute, data.distance);
                });
        });

        // End rute finding function

        // Selecting a destination point

        let selecting = 0;
        let selectedCoord = null;
        let markerOrigin = null;
        let markerDestiny = null;
        let mapContainer = document.getElementById("map")

        document.getElementById("btnUserLocationOrigin").addEventListener("click", () => {
            selecting = 1;
            map.getCanvas().classList.add("crosshair");
            console.log("üü¢ Modo selecci√≥n activado (Origen): haz clic en el mapa");
        });

        document.getElementById("btnUserLocationDestiny").addEventListener("click", () => {
            selecting = 2;
            map.getCanvas().classList.add("crosshair");
            console.log("üü¢ Modo selecci√≥n activado (Destino): haz clic en el mapa");
        });

        // If a user clicks the map
        map.on("click", (e) => {
            if (selecting === 0) return; // no estamos seleccionando

            if (selecting === 1) {
                // inicio
                selectedCoordOrigin = [e.lngLat.lng, e.lngLat.lat];

                if (markerOrigin) {
                    markerOrigin.setLngLat(selectedCoordOrigin);
                } else {
                    markerOrigin = new mapboxgl.Marker({ color: "blue" })
                        .setLngLat(selectedCoordOrigin)
                        .addTo(map);
                }
            } else {
                // destino
                selectedCoordDestiny = [e.lngLat.lng, e.lngLat.lat];

                if (markerDestiny) {
                    markerDestiny.setLngLat(selectedCoordDestiny);
                } else {
                    markerDestiny = new mapboxgl.Marker({ color: "red" })
                        .setLngLat(selectedCoordDestiny)
                        .addTo(map);
                }
            }
            // Salimos del modo selecci√≥n
            selecting = 0;
            map.getCanvas().classList.remove("crosshair");
        });

    </script>

</body>

</html>