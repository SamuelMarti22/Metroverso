{% load static %}
<!DOCTYPE html>
<html>
<head>


<meta charset="utf-8">
<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">

<!--MapBox imports-->
<link href="https://api.mapbox.com/mapbox-gl-js/v3.13.0/mapbox-gl.css" rel="stylesheet">
<script src="https://api.mapbox.com/mapbox-gl-js/v3.13.0/mapbox-gl.js"></script>

<!--Turf import-->
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>


<!--CSS/style imports-->
<link rel="stylesheet" href="{% static 'css/mapStyle.css' %}">

<!--JS/js-->

</head>
<body>

<!--Map Container-->
<div id="map"></div>
<button id="btnLocation">Mi ubicaci√≥n</button>

<!----->
<script>
mapboxgl.accessToken = 'pk.eyJ1IjoibGFjYXRyaWxmIiwiYSI6ImNtZG00eGJqZjAxMGYyaXBrcGY3b2tjYzIifQ.gx3C4J17a-6YrUBt6sZTmQ';

const initialLocationView = [-75.5752,6.2491]; // Coordinates of San Antonio

    const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/standard', // Style of the map
        config: {
            basemap: {
                theme: 'monochrome'
            }
        },
        center: initialLocationView,
        zoom: 15
    });

    // Global variables to store user marker
        let userMarker = null;
        let watchId = null;
        let lastUpdateTime = 0;
        const UPDATE_INTERVAL = 1000; // Update interval in milliseconds

        // Function to get user location
        function getUserLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function (position) {
                        updateUserLocation(position);
                        startLocationTracking();
                    },
                    handleLocationError,
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,           
                        maximumAge: 0           
                    }
                );
            }
        }

        // Function to update user location
        function updateUserLocation(position) {
            const userLat = position.coords.latitude;
            const userLng = position.coords.longitude;
            const accuracy = position.coords.accuracy;
            const currentTime = Date.now();

            // Limit very frequent updates
            if (currentTime - lastUpdateTime < UPDATE_INTERVAL) {
                return;
            }

            console.log("Location accuracy:", Math.round(accuracy * 100) / 100, "m");
            if (accuracy > 100) {
                console.warn("Low location precision");
                return;
            }

            lastUpdateTime = currentTime;

            if (!userMarker) {
                // Create custom marker
                const markerElement = document.createElement('div');
                markerElement.innerHTML = 'üìç';
                markerElement.style.fontSize = '20px';
                markerElement.style.cursor = 'pointer';

                userMarker = new mapboxgl.Marker({ element: markerElement })
                    .setLngLat([userLng, userLat])
                    .setPopup(new mapboxgl.Popup({ 
                        closeButton: false,
                        offset: [0, -10]
                    }).setText('Tu ubicaci√≥n'))
                    .addTo(map);
            } else {
                // If marker already exists, just update its position
                userMarker.setLngLat([userLng, userLat]);
            }
        }

        // Function to start optimized tracking
        function startLocationTracking() {
            watchId = navigator.geolocation.watchPosition(
                updateUserLocation,
                handleLocationError,
                {
                    enableHighAccuracy: true,
                    timeout: 5000,
                    maximumAge: UPDATE_INTERVAL
                }
            );
        }

        // Function to handle location errors
        function handleLocationError(error) {
            console.warn('Could not get location:', error.message);

            switch (error.code) {
                case error.PERMISSION_DENIED:
                    console.warn('Permission denied to access location.');
                    break;
                case error.POSITION_UNAVAILABLE:
                    console.warn('Location information is not available.');
                    break;
                case error.TIMEOUT:
                    console.warn('Location request timed out.');
                    break;
                default:
                    console.warn('Error getting location.');
                    break;
            }
        }

        // Function to stop location tracking
        function stopLocationTracking() {
            if (watchId !== null) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
        }

        // Function to get walking route
        async function walkingRoute(start, end) {
            const query = await fetch(
                `https://api.mapbox.com/directions/v5/mapbox/walking/${start[0]},${start[1]};${end[0]},${end[1]}?steps=true&geometries=geojson&overview=full&approaches=unrestricted;unrestricted&access_token=${mapboxgl.accessToken}`,
                { method: 'GET' }
            );
            const json = await query.json();
            const data = json.routes[0];
            return data;
        }

        // Function to add route to map
        function addRouteToMap(route, routeId = 'walking-route') {
            // Remove existing route if it exists
            if (map.getSource(routeId)) {
                map.removeLayer(routeId);
                map.removeSource(routeId);
            }

            // Add route source and layer
            map.addSource(routeId, {
                type: 'geojson',
                data: {
                    type: 'Feature',
                    properties: {},
                    geometry: route.geometry
                }
            });

            map.addLayer({
                id: routeId,
                type: 'line',
                source: routeId,
                layout: {
                    'line-join': 'round',
                    'line-cap': 'round'
                },
                paint: {
                    'line-color': '#4CAF50',
                    'line-width': 4,
                    'line-opacity': 0.8,
                    'line-dasharray':  [2, 2]
                }
            });
        }

        map.on('load', function() {
            getUserLocation();

            const lastPoint = turf.point([-75.581547, 6.194671]);
            const destination = turf.point([-75.585684, 6.191629]);

            // Get walking route and draw it
            walkingRoute(lastPoint.geometry.coordinates, destination.geometry.coordinates)
            .then(route => {
                addRouteToMap(route, "lastRoute");
            })
            .catch(error => {
                console.error('Error getting route:', error);
            });
        });

     document.getElementById('btnLocation').addEventListener('click', function () {
            if (userMarker) {
                map.flyTo({
                    center: userMarker.getLngLat(),
                    zoom: 15,
                    essential: true
                });
            } else {
                console.warn('No se ha podido encontrar la ubicaci√≥n.');
            }
        });
</script>

</body>
</html>

