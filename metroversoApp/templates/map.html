{% load static %} {% load i18n %}
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />

    <!--MapBox imports-->
    <link
      href="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.css"
      rel="stylesheet"
    />
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.js"></script>

    <!--Turf import-->
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

    <!--Shepherd.js - Tutorial interactivo-->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/shepherd.js@11.2.0/dist/css/shepherd.css"/>
    <script src="https://cdn.jsdelivr.net/npm/shepherd.js@11.2.0/dist/js/shepherd.min.js"></script>

    <!--JS/js-->
    <script>
      // Configuration for the application
      window.APP_CONFIG = {
        geojsonUrl: "{% static 'geojson/Lineas_Sistema_Metro.geojson' %}",
        geojsonComplete:
          "{% static 'geojson/Lineas_Sistema_Metro_-OD.geojson' %}",
      };

      // Constants for language translation
      const texts = {
        words: {
          note: "{% trans 'Note' %}",
          state: "{% trans 'Status' %}",
          open: "{% trans 'Open' %}",
          closed: "{% trans 'Closed' %}",
          noName: "{% trans '(no name)' %}",
        },
        labels: {
          myLocation: "{% trans 'My location' %}",
        },
        criteria: {
          tiempo: "{% trans 'Time' %}",
          distancia: "{% trans 'Distance' %}",
          precio: "{% trans 'Price' %}",
        },
        serviceHours: {
          title: "{% trans 'Service Hours' %}",
          arviStation: "{% trans 'Arvi Station' %}",
          arviStationInfo: "{% trans 'Special schedule for Arvi station' %}",
          days: [
            "{% trans 'Monday' %}",
            "{% trans 'Tuesday' %}",
            "{% trans 'Wednesday' %}",
            "{% trans 'Thursday' %}",
            "{% trans 'Friday' %}",
            "{% trans 'Saturday' %}",
            "{% trans 'Sunday' %}",
          ],
        },
        routeInformation: {
          title: "{% trans 'Route Information' %}",
          fullRoute: "{% trans 'Full route' %}",
          transferTextPlural: "{% trans '{n} transfers are required' %}",
          transferTextSingular: "{% trans '1 transfer is required' %}",
          transferStationsTitle: "{% trans 'Transfer stations' %}",
          transferAt: "{% trans 'Transfer at: {station}' %}",
          transferFollowTitle: "{% trans 'Transfer instructions' %}",
          transferHint:
            "{% trans 'At {station}, change to line {line} and go to {nextStation}.' %}",
          noTransfersRequired: "{% trans 'No transfers are required' %}",
          directTrip: "{% trans 'Direct trip on line {line}' %}",
        },
        alerts: {
          locationUnavailable:
            "{% trans 'Location information is not available.' %}",
          locationTimeout: "{% trans 'Location request timed out.' %}",
          locationError: "{% trans 'Error getting location.' %}",
          couldNotFindLocation: "{% trans 'Could not find location.' %}",
          originTooFar:
            "{% trans 'The distance from the origin to the first station is greater than 2 km' %}",
          destinationTooFar:
            "{% trans 'The nearest station to the destination is more than 2 km away' %}",
          routeError: "{% trans 'Error fetching route. Please try again.' %}",
          tripNotPossible:
            "{% trans '⚠️ The trip cannot be completed within the metro operating hours.' %}",
          arviTripNotPossible:
            "{% trans '⚠️ The trip cannot be completed within the operating hours of Arvi station (9:00-18:00 Mon-Sat, 8:30-18:00 Sun).' %}",
        },
      };
    </script>
    <script
      src="{% static 'js/dataTurf.js' %}"
      onload="console.log('dataTurf cargado');"
    ></script>
    <script
      src="{% static 'js/functions.js' %}"
      onload="console.log('functions cargado');"
    ></script>

    <!--CSS/style imports-->
    <link rel="stylesheet" href="{% static 'css/Stylemap.css' %}" />

    <!-- Bootstrap JS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <style>
      /* Estilos personalizados para tooltips de la sidebar */
      .tooltip.sidebar-tooltip .tooltip-inner {
        background-color: #20c997;
        color: white;
        font-size: 0.95rem;
        font-weight: 500;
        padding: 8px 14px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(32, 201, 151, 0.3);
      }
      
      .tooltip.sidebar-tooltip .tooltip-arrow::before {
        border-right-color: #20c997;
      }
    </style>
    <script>
    // Inicializa todos los tooltips de la página
    document.addEventListener('DOMContentLoaded', () => {
      // Inicializar tooltips en elementos de la sidebar
      const sidebarButtons = document.querySelectorAll('.sidebar [title]');
      sidebarButtons.forEach(el => {
        new bootstrap.Tooltip(el, {
          placement: 'right',
          trigger: 'hover',
          customClass: 'sidebar-tooltip'
        });
      });
      
      // Inicializar otros tooltips estándar
      const otherTooltips = document.querySelectorAll('[data-bs-toggle="tooltip"]:not(.sidebar [title])');
      otherTooltips.forEach(el => new bootstrap.Tooltip(el));
    });
    </script>
  </head>

  <body>
    <!--Map Container-->
    <div id="map"></div>

    <!-- Validation alert -->
    <div
      id="alerta-validacion"
      class="alert alert-warning alert-dismissible fade show position-absolute top-0 start-50 translate-middle-x mt-3"
      role="alert"
      style="display: none; z-index: 9999; max-width: 600px"
    >
      <span id="mensaje-alerta">Alert message here</span>
    </div>

    <!-- Sidebar -->
    <div class="sidebar d-flex flex-column">
      <div class="icon d-flex justify-content-center align-items-center">
        <img
          src="{% static 'images/LogoB.png' %}"
          alt="Metroverso Logo"
          width="55"
          height="55"
          style="border-radius: 8px"
        />
      </div>

      <div
        class="subCategory d-flex justify-content-center align-items-center active"
        type="button"
        data-bs-toggle="offcanvas"
        data-bs-target="#offcanvasScrolling"
        aria-controls="offcanvasScrolling"
        title="{% trans 'Route Planner' %}"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="18"
          height="18"
          fill="currentColor"
          class="bi bi-compass-fill"
          viewBox="0 0 16 16"
        >
          <path
            d="M15.5 8.516a7.5 7.5 0 1 1-9.462-7.24A1 1 0 0 1 7 0h2a1 1 0 0 1 .962 1.276 7.5 7.5 0 0 1 5.538 7.24m-3.61-3.905L6.94 7.439 4.11 12.39l4.95-2.828 2.828-4.95z"
          />
        </svg>
      </div>

      <div
        class="subCategory d-flex justify-content-center align-items-center"
        type="button"
        data-bs-toggle="offcanvas"
        data-bs-target="#offcanvasLines"
        aria-controls="offcanvasLines"
        title="{% trans 'Metro Lines' %}"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="18"
          height="18"
          fill="currentColor"
          class="bi bi-signpost-2-fill"
          viewBox="0 0 16 16"
        >
          <path
            d="M7.293.707A1 1 0 0 0 7 1.414V2H2a1 1 0 0 0-1 1v2a1 1 0 0 0 1 1h5v1H2.5a1 1 0 0 0-.8.4L.725 8.7a.5.5 0 0 0 0 .6l.975 1.3a1 1 0 0 0 .8.4H7v5h2v-5h5a1 1 0 0 0 1-1V8a1 1 0 0 0-1-1H9V6h4.5a1 1 0 0 0 .8-.4l.975-1.3a.5.5 0 0 0 0-.6L14.3 2.4a1 1 0 0 0-.8-.4H9v-.586A1 1 0 0 0 7.293.707"
          />
        </svg>
      </div>

      <!-- Dashboard icon -->
      <div
        class="subCategory d-flex justify-content-center align-items-center"
        type="button"
        data-bs-toggle="offcanvas"
        data-bs-target="#offcanvasDashboard"
        aria-controls="offcanvasDashboard"
        title="{% trans 'Dashboard' %}"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="18"
          height="18"
          fill="currentColor"
          class="bi bi-star-fill"
          viewBox="0 0 16 16"
        >
          <path
            d="M3.612 15.443c-.386.198-.824-.149-.746-.592l.83-4.73L.173 6.765c-.329-.32-.158-.888.283-.95l4.898-.696L7.538.792c.197-.39.73-.39.927 0l2.184 4.327 4.898.696c.441.062.612.63.283.95l-3.523 3.356.83 4.73c.078.443-.36.79-.746.592L8 13.187l-4.389 2.256z"
          />
        </svg>
      </div>

      <div 
        class="subCategory d-flex justify-content-center align-items-center"
        title="{% trans 'Explore' %}"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="18"
          height="18"
          fill="currentColor"
          class="bi bi-radar"
          viewBox="0 0 16 16"
        >
          <path
            d="M6.634 1.135A7 7 0 0 1 15 8a.5.5 0 0 1-1 0 6 6 0 1 0-6.5 5.98v-1.005A5 5 0 1 1 13 8a.5.5 0 0 1-1 0 4 4 0 1 0-4.5 3.969v-1.011A2.999 2.999 0 1 1 11 8a.5.5 0 0 1-1 0 2 2 0 1 0-2.5 1.936v-1.07a1 1 0 1 1 1 0V15.5a.5.5 0 0 1-1 0v-.518a7 7 0 0 1-.866-13.847"
          />
        </svg>
      </div>

      <div
        class="subCategory d-flex justify-content-center align-items-center"
        type="button"
        data-bs-toggle="offcanvas"
        data-bs-target="#languageOffcanvas"
        aria-controls="languageOffcanvas"
        title="{% trans 'Language' %}"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="18"
          height="18"
          fill="currentColor"
          class="bi bi-translate"
          viewBox="0 0 16 16"
        >
          <path
            d="M4.545 6.714 4.11 8H3l1.862-5h1.284L8 8H6.833l-.435-1.286zm1.634-.736L5.5 3.956h-.049l-.679 2.022z"
          />
          <path
            d="M0 2a2 2 0 0 1 2-2h7a2 2 0 0 1 2 2v3h3a2 2 0 0 1 2 2v7a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-3H2a2 2 0 0 1-2-2zm2-1a1 1 0 0 0-1 1v7a1 1 0 0 0 1 1h7a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1zm7.138 9.995q.289.451.63.846c-.748.575-1.673 1.001-2.768 1.292.178.217.451.635.555.867 1.125-.359 2.08-.844 2.886-1.494.777.665 1.739 1.165 2.93 1.472.133-.254.414-.673.629-.89-1.125-.253-2.057-.694-2.82-1.284.681-.747 1.222-1.651 1.621-2.757H14V8h-3v1.047h.765c-.318.844-.74 1.546-1.272 2.13a6 6 0 0 1-.415-.492 2 2 0 0 1-.94.31"
          />
        </svg>
      </div>

      <div 
        class="profileIcon d-flex justify-content-center align-items-center"
        type="button"
        data-bs-toggle="offcanvas"
        data-bs-target="#profileOffcanvas"
        aria-controls="profileOffcanvas"
        style="cursor: pointer;"
        title="{% trans 'Profile' %}"
      >
        {% if user_data.is_authenticated %}
          <!-- Usuario autenticado - icono con indicador -->
          <div class="position-relative">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="20"
              height="20"
              fill="white"
              class="bi bi-person-fill"
              viewBox="0 0 16 16"
            >
              <path
                d="M3 14s-1 0-1-1 1-4 6-4 6 3 6 4-1 1-1 1zm5-6a3 3 0 1 0 0-6 3 3 0 0 0 0 6"
              />
            </svg>
            <!-- Indicador de usuario logueado -->
            <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill" 
                  style="background-color: #20c997; font-size: 6px; padding: 2px;">
              ●
            </span>
          </div>
        {% else %}
          <!-- Usuario no autenticado - icono normal -->
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="20"
            height="20"
            fill="white"
            class="bi bi-person"
            viewBox="0 0 16 16"
          >
            <path
              d="M8 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6m2-3a2 2 0 1 1-4 0 2 2 0 0 1 4 0m4 8c0 1-1 1-1 1H3s-1 0-1-1 1-4 6-4 6 3 6 4"
            />
          </svg>
        {% endif %}
      </div>
    </div>

    <!-- Dashboard Offcanvas -->
    <div class="offcanvasContainer">
      <div
        class="offcanvas offcanvas-start"
        data-bs-scroll="true"
        data-bs-backdrop="false"
        tabindex="-1"
        id="offcanvasDashboard"
        aria-labelledby="offcanvasDashboardLabel"
      >
        <div class="offcanvas-header border-bottom">
          <h5
            class="offcanvas-title text-success fw-bold"
            id="offcanvasDashboardLabel"
          >
            <i class="bi bi-star-fill me-2"></i> {% trans "Dashboard" %}
          </h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="offcanvas"
            aria-label="Close"
          ></button>
        </div>
        <div class="offcanvas-body">
          <div id="dashboard-content">
            <div class="fw-bold mb-2 text-success">
              {% trans "Most Used Stations" %}
            </div>
            <div id="dashboard-stations"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Offcanvas Panel -->
    <div class="offcanvasContainer">
      <div
        class="offcanvas offcanvas-start"
        data-bs-scroll="true"
        data-bs-backdrop="false"
        tabindex="-1"
        id="offcanvasScrolling"
        aria-labelledby="offcanvasScrollingLabel"
      >
        <div class="offcanvas-header border-bottom">
          <h5
            class="offcanvas-title text-success fw-bold"
            id="offcanvasScrollingLabel"
          >
            {% trans "Metro Route Planner" %}
          </h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="offcanvas"
            aria-label="Close"
          ></button>
        </div>
        <div class="offcanvas-body">
          <div class="divRute">
            <div class="mb-3 position-relative">
                <label for="inputStart" class="form-label text-muted small">
                {% trans "Start Station" %}
                </label>
                <input id="inputStart" placeholder="{% trans 'Start' %}" autocomplete="off" class="form-control"/>

                <!-- Lista de sugerencias para Start -->
                <ul id="sugsStart" class="list-group shadow-sm" style="display:none; position:absolute; z-index:1000; width:100%; max-height:280px; overflow:auto; background-color: wheat;"></ul>
            </div>

            <div class="mb-3 position-relative">
                <label for="inputDestination" class="form-label text-muted small">
                {% trans "Destination Station" %}
                </label>
                <input id="inputDestination" placeholder="{% trans 'Destination' %}" autocomplete="off" class="form-control"/>

                <!-- Lista de sugerencias para Start -->
                <ul id="sugsDestination" class="list-group shadow-sm" style="display:none; position:absolute; z-index:1000; width:100%; max-height:280px; overflow:auto; background-color: wheat;"></ul>
            </div>

            <select id="selectStart" class="form-select visually-hidden"></select>
            <select id="selectDestination" class="form-select visually-hidden"></select>

            <!-- perfil type filter -->
            <div class="mb-3">
              <label for="profileSelection" class="form-label text-muted small">{% trans "Profile" %}:</label>
              <select id="profileSelection" class="form-select" aria-label="Select passenger type">
                <option selected value="Frecuente">{% trans "Frequent" %}</option>
                <option value="AdultoMayor">{% trans "Senior" %}</option>
                <option value="Estudiantil">{% trans "Student" %}</option>
                <option value="PcD">{% trans "PcD" %}</option>
                <option value="Eventual">{% trans "Occasional" %}</option>
              </select>
            </div>

            <label for="inputDestination" class="form-label text-muted small">{% trans "Filter by" %}:</label>
            <div style="display: flex; flex-direction: row; gap: 5px;">
              <select class="form-select" aria-label="Default select example" id="inputCriteria">
                <option selected value="time">{% trans "Time" %}</option>
                <option value="distance_km">{% trans "Distance" %}</option>
                <option value="price">{% trans "Price" %}</option>
              </select>
              <button
                class="btn btn-primary w-100 fw-semibold"
                id="btnSearchRute"
              >
                <i class="bi bi-search me-2"></i>{% trans "Search Route" %}
              </button>
            </div>
            <button
              class="btn btn-primary w-100 fw-semibold mt-2"
              id="btnStartJourney"
              style="display: none"
            >
              <i class="bi bi-play-circle me-2"></i>{% trans "Start Journey" %}
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Offcanvas Lines Panel -->
    <div class="offcanvasContainer">
      <div
        class="offcanvas offcanvas-start"
        data-bs-scroll="true"
        data-bs-backdrop="false"
        tabindex="-1"
        id="offcanvasLines"
        aria-labelledby="offcanvasLinesLabel"
      >
        <div class="offcanvas-header border-bottom">
          <h5
            class="offcanvas-title text-success fw-bold"
            id="offcanvasScrollingLabel"
          >
            {% trans "Show lines" %}
          </h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="offcanvas"
            aria-label="Close"
          ></button>
        </div>
        <div class="offcanvas-body">
          <div class="divRute">
            <div class="mb-3">
              <p>
                {% blocktrans %}Search for a specific line and see its route displayed on the map{% endblocktrans %}
              </p>
              <label for="lineSelection">{% trans "Line" %}:</label>
              <select
                id="lineSelection"
                class="form-select"
                aria-label="{% trans 'Select line' %}"
              >
                <option selected disabled>
                  -- {% trans "Select a line" %} --
                </option>
                <option value="ALL">{% trans "All lines" %}</option>
                <option value="A">A</option>
                <option value="B">B</option>
                <option value="H">H</option>
                <option value="J">J</option>
                <option value="K">K</option>
                <option value="L">L</option>
                <option value="M">M</option>
                <option value="P">P</option>
                <option value="T">T</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="O">O</option>
              </select>
            </div>
            <button class="btn btn-primary w-100 fw-semibold" id="btnShowLines">
              <i class="bi bi-search me-2"></i>{% trans "Search Line" %}
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Offcanvas Most Used Stations Panel -->
    <div class="offcanvasContainer">
      <div
        class="offcanvas offcanvas-start"
        data-bs-scroll="true"
        data-bs-backdrop="false"
        tabindex="-1"
        id="offcanvasMostUsedStations"
        aria-labelledby="offcanvasMostUsedStationsLabel"
      >
        <div class="offcanvas-header border-bottom">
          <h5
            class="offcanvas-title text-success fw-bold"
            id="offcanvasMostUsedStationsLabel"
          >
            {% trans "Most Used Stations" %}
          </h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="offcanvas"
            aria-label="Close"
          ></button>
        </div>
        <div class="offcanvas-body">
          <ul
            id="mostUsedStationsList"
            style="list-style: none; padding-left: 0; margin-bottom: 0"
          >
            <li>{% trans "Loading" %}...</li>
          </ul>
        </div>
      </div>
    </div>

    <!-- Language Offcanvas Panel -->
    <div class="languageContainer">
      <div
        class="offcanvas offcanvas-start"
        data-bs-scroll="true"
        data-bs-backdrop="false"
        tabindex="-1"
        id="languageOffcanvas"
        aria-labelledby="languageOffcanvasLabel"
      >
        <div class="offcanvas-header border-bottom">
          <h5
            class="offcanvas-title text-success fw-bold"
            id="languageOffcanvasLabel"
          >
            {% trans "Select Language" %}
          </h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="offcanvas"
            aria-label="Close"
          ></button>
        </div>
        <form
          id="language-form"
          action="{% url 'set_language' %}"
          method="post"
        >
          {% csrf_token %}
          <input type="hidden" name="next" value="{{ request.path }}" />
          <input type="hidden" name="language" id="language-input" />
        </form>
        <div class="offcanvas-body">
          <div class="language-list">
            <div
              class="language-item {% if LANGUAGE_CODE == 'es' %}selected{% endif %}"
              onclick="changeLanguage('es')"
            >
              <div
                class="language-flag"
                style="
                  background: linear-gradient(
                    to bottom,
                    #aa151b 0%,
                    #aa151b 33.33%,
                    #f1bf00 33.33%,
                    #f1bf00 66.66%,
                    #aa151b 66.66%,
                    #aa151b 100%
                  );
                "
              ></div>
              <span>Español</span>
              <i class="bi bi-check-circle-fill ms-auto text-success"></i>
            </div>
            <div
              class="language-item {% if LANGUAGE_CODE == 'en' %}selected{% endif %}"
              onclick="changeLanguage('en')"
            >
              <div
                class="language-flag"
                style="
                  background: linear-gradient(
                        135deg,
                        #012169 25%,
                        transparent 25%
                      ) -10px 0,
                    linear-gradient(225deg, #012169 25%, transparent 25%) -10px 0,
                    linear-gradient(315deg, #012169 25%, transparent 25%),
                    linear-gradient(45deg, #012169 25%, transparent 25%);
                  background-size: 20px 20px;
                  background-color: #ffffff;
                  position: relative;
                "
              >
                <div
                  style="
                    position: absolute;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: repeating-linear-gradient(
                        0deg,
                        #ffffff 0px,
                        #ffffff 2px,
                        #ce1124 2px,
                        #ce1124 4px
                      ),
                      repeating-linear-gradient(
                        90deg,
                        #ffffff 0px,
                        #ffffff 2px,
                        #ce1124 2px,
                        #ce1124 4px
                      );
                  "
                ></div>
                <div
                  style="
                    position: absolute;
                    top: 0;
                    left: 0;
                    width: 50%;
                    height: 50%;
                    background: #012169;
                  "
                ></div>
              </div>
              <span>English</span>
              <i class="bi bi-check-circle-fill ms-auto text-success"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Profile Offcanvas -->
    <div class="offcanvasContainer">
      <div
        class="offcanvas offcanvas-start"
        data-bs-scroll="true"
        data-bs-backdrop="false"
        tabindex="-1"
        id="profileOffcanvas"
        aria-labelledby="profileOffcanvasLabel"
      >
      <div class="offcanvas-header border-bottom">
        <h5
          class="offcanvas-title text-success fw-bold"
          id="profileOffcanvasLabel"
        >
          <i class="bi bi-person-fill me-2"></i> 
          {% if user_data.is_authenticated %}
            {% trans "My Profile" %}
          {% else %}
            {% trans "Sign In" %}
          {% endif %}
        </h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="offcanvas"
          aria-label="Close"
        ></button>
      </div>
      <div class="offcanvas-body">
        {% if user_data.is_authenticated %}
          <!-- Usuario autenticado -->
          <div class="text-center mb-4">
            <div class="bg-success bg-opacity-10 rounded-circle d-inline-flex justify-content-center align-items-center" 
                 style="width: 80px; height: 80px;">
              <i class="bi bi-person-fill text-success" style="font-size: 2.5rem;"></i>
            </div>
            <h6 class="mt-3 mb-1 fw-bold">{{ user_data.username }}</h6>
            {% if user_data.metro_profile %}
              <small class="text-muted">{{ user_data.metro_profile.name }}</small>
              <div class="mt-2">
                <span class="badge bg-success bg-opacity-10 text-success">
                  {{ user_data.metro_profile.perfil }}
                </span>
              </div>
            {% endif %}
          </div>
          
          <div class="d-grid gap-2">
            <button type="button" class="btn btn-outline-success" onclick="showProfileEditor()">
              <i class="bi bi-person-gear me-2"></i>{% trans "Edit Profile" %}
            </button>
            <a href="/auth/logout/" class="btn btn-outline-danger">
              <i class="bi bi-box-arrow-right me-2"></i>{% trans "Sign Out" %}
            </a>
          </div>
          
          <!-- Profile Editor (hidden by default) -->
          <div id="profileEditor" style="display: none;">
            <hr class="my-4">
            <h6 class="text-success mb-3">
              <i class="bi bi-pencil-square me-2"></i>{% trans "Edit Information" %}
            </h6>
            <form id="profileForm">
              {% csrf_token %}
              <div class="mb-3">
                <label for="profileName" class="form-label small">{% trans "Full Name" %}</label>
                <input type="text" class="form-control form-control-sm" id="profileName" name="name">
              </div>
              <div class="mb-3">
                <label for="profilePerfil" class="form-label small">{% trans "Passenger Type" %}</label>
                <select class="form-select form-select-sm" id="profilePerfil" name="perfil">
                  <option value="Frecuente">{% trans "Frequent" %}</option>
                  <option value="AdultoMayor">{% trans "Senior" %}</option>
                  <option value="Estudiantil">{% trans "Student" %}</option>
                  <option value="PcD">{% trans "PcD" %}</option>
                </select>
              </div>
              <div class="d-grid gap-2">
                <button type="submit" class="btn btn-success btn-sm">
                  <i class="bi bi-check-circle me-2"></i>{% trans "Save Changes" %}
                </button>
                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="hideProfileEditor()">
                  <i class="bi bi-x-circle me-2"></i>{% trans "Cancel" %}
                </button>
              </div>
            </form>
          </div>
        {% else %}
          <!-- Usuario no autenticado -->
          <div class="text-center mb-4">
            <div class="bg-secondary bg-opacity-10 rounded-circle d-inline-flex justify-content-center align-items-center" 
                 style="width: 80px; height: 80px;">
              <i class="bi bi-person text-secondary" style="font-size: 2.5rem;"></i>
            </div>
            <h6 class="mt-3 mb-1">{% trans "Welcome to Metroverso!" %}</h6>
            <small class="text-muted">{% trans "Sign in to personalize your experience" %}</small>
          </div>
          
          <div class="d-grid gap-2">
            <a href="/auth/login/" class="btn btn-success">
              <i class="bi bi-box-arrow-in-right me-2"></i>{% trans "Sign In" %}
            </a>
            <a href="/auth/register/" class="btn btn-outline-success">
              <i class="bi bi-person-plus me-2"></i>{% trans "Create Account" %}
            </a>
          </div>
          
          <hr class="my-4">
          
          <div class="text-center">
            <small class="text-muted">
              {% trans "With an account you can:" %}
            </small>
            <ul class="list-unstyled mt-2 small text-muted">
              <li><i class="bi bi-check-circle text-success me-2"></i>{% trans "Save your favorite routes" %}</li>
              <li><i class="bi bi-check-circle text-success me-2"></i>{% trans "Customize your traveler profile" %}</li>
              <li><i class="bi bi-check-circle text-success me-2"></i>{% trans "Access the dashboard" %}</li>
            </ul>
          </div>
        {% endif %}
      </div>
    </div>
    </div>

    <!-- Location Controls Container -->
    <div class="location-controls">
      <!-- Origin Location Button
      <div
        class="userLocation1"
        id="btnUserLocationOrigin"
        title="{% trans 'Set as starting point' %}"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="16"
          height="16"
          fill="currentColor"
          class="bi bi-person-walking"
          viewBox="0 0 16 16"
        >
          <path
            d="M9.5 1.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0M6.44 3.752A.75.75 0 0 1 7 3.5h1.445c.742 0 1.32.643 1.243 1.38l-.43 4.083a1.8 1.8 0 0 1-.088.395l-.318.906.213.242a.8.8 0 0 1 .114.175l2 4.25a.75.75 0 1 1-1.357.638l-1.956-4.154-1.68-1.921A.75.75 0 0 1 6 8.96l.138-2.613-.435.489-.464 2.786a.75.75 0 1 1-1.48-.246l.5-3a.75.75 0 0 1 .18-.375l2-2.25Z"
          />
          <path
            d="M6.25 11.745v-1.418l1.204 1.375.261.524a.8.8 0 0 1-.12.231l-2.5 3.25a.75.75 0 1 1-1.19-.914zm4.22-4.215-.494-.494.205-1.843.006-.067 1.124 1.124h1.44a.75.75 0 0 1 0 1.5H11a.75.75 0 0 1-.531-.22Z"
          />
        </svg>
      </div> -->

      <!-- Destination Location Button -->
      <div
        class="userLocation2"
        id="btnUserLocationDestiny"
        title="{% trans 'Set as destination' %}"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="16"
          height="16"
          fill="currentColor"
          class="bi bi-person-standing"
          viewBox="0 0 16 16"
        >
          <path
            d="M8 3a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3M6 6.75v8.5a.75.75 0 0 0 1.5 0V10.5a.5.5 0 0 1 1 0v4.75a.75.75 0 0 0 1.5 0v-8.5a.25.25 0 1 1 .5 0v2.5a.75.75 0 0 0 1.5 0V6.5a3 3 0 0 0-3-3H7a3 3 0 0 0-3 3v2.75a.75.75 0 0 0 1.5 0v-2.5a.25.25 0 0 1 .5 0"
          />
        </svg>
      </div>

      <!-- Current Location Button -->
      <div class="userLocation" title="{% trans 'My location' %}">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="16"
          height="16"
          fill="green"
          class="bi bi-person-arms-up"
          viewBox="0 0 16 16"
        >
          <path d="M8 3a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3" />
          <path
            d="m5.93 6.704-.846 8.451a.768.768 0 0 0 1.523.203l.81-4.865a.59.59 0 0 1 1.165 0l.81 4.865a.768.768 0 0 0 1.523-.203l-.845-8.451A1.5 1.5 0 0 1 10.5 5.5L13 2.284a.796.796 0 0 0-1.239-.998L9.634 3.84a.7.7 0 0 1-.33.235c-.23.074-.665.176-1.304.176-.64 0-1.074-.102-1.305-.176a.7.7 0 0 1-.329-.235L4.239 1.286a.796.796 0 0 0-1.24.998l2.5 3.216c.317.316.475.758.43 1.204Z"
          />
        </svg>
      </div>
    </div>

    <!-- Closest station buttons -->
    <div
      class="position-absolute top-0 end-0 m-3"
      id="closestStationsBox"
      style="z-index: 1050; display: none"
    >
      <div
        class="bg-white border rounded shadow p-2 d-flex flex-column align-items-center"
        style="width: 120px"
      >
        <button
          type="button"
          class="btn btn-outline-success btn-sm w-100 mb-2"
          id="btnUserLocation"
          title="{% trans 'My location' %}"
        >
          {% trans 'My location' %}
        </button>
        <button
          type="button"
          class="btn btn-outline-primary btn-sm w-100 mb-2"
          id="btnClosestStation1"
          title="{% trans 'Nearest station 1' %}"
        ></button>
        <button
          type="button"
          class="btn btn-outline-danger btn-sm w-100 mb-2"
          id="btnClosestStation2"
          title="{% trans 'Nearest station 2' %}"
        ></button>
        <button
          type="button"
          class="btn btn-outline-warning btn-sm w-100"
          id="btnClosestStation3"
          title="{% trans 'Nearest station 3' %}"
        ></button>
      </div>
    </div>

  <div class="estimated-info-container">
  <div id="estimatedTimeBox">
      <div style="font-size: 1rem; font-weight: 400">
        {% trans "Estimated Time" %}
      </div>
      <div
        id="estimatedTimeValue"
        style="font-size: 1.5rem; font-weight: 700; margin-top: 4px"
      >
        -- {% trans "min" %}
      </div>
      <div style="position: absolute; right: 24px; top: 16px">
        <svg
          width="28"
          height="28"
          viewBox="0 0 24 24"
          fill="none"
          stroke="#c2f2e3"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <circle cx="12" cy="12" r="10" />
          <polyline points="12 6 12 12 16 14" />
        </svg>
      </div>
  </div>

  <div id="estimatedPriceBox">
  <div style="font-size: 1rem; font-weight: 400">
    {% trans "Estimated Price" %}
  </div>
  <div
    id="estimatedPriceValue"
    style="font-size: 1.5rem; font-weight: 700; margin-top: 4px"
  >
    -- {% trans "COP" %}
  </div>
  <div style="position: absolute; right: 24px; top: 16px">
  </div>
  </div>
  </div>

    <script src="{% static 'js/mapScript.js' %}"></script>
    <script src="{% static 'js/dictionary.js' %}"></script>
    <script src="{% static 'js/tutorial.js' %}"></script>
    <script>
      async function fetchMostUsedStations() {
        try {
          const res = await fetch("/view/most-used-stations");
          const data = await res.json();
          const list = document.getElementById("mostUsedStationsList");
          list.innerHTML = "";
          if (data.top_stations && data.top_stations.length > 0) {
            data.top_stations.forEach((st) => {
              const li = document.createElement("li");
              li.innerHTML = `<span class=\"fw-bold\">${st.name}</span> <span class=\"badge bg-success ms-2\">${st.usage}</span>`;
              list.appendChild(li);
            });
          } else {
            list.innerHTML = "<li>No data available</li>";
          }
        } catch (e) {
          document.getElementById("mostUsedStationsList").innerHTML =
            "<li>Error loading data</li>";
        }
      }
      document
        .getElementById("offcanvasMostUsedStations")
        .addEventListener("show.bs.offcanvas", fetchMostUsedStations);

      function fetchDashboard() {
        fetch("/dashboard/")
          .then((response) => response.json())
          .then((data) => {
            const stations = data.top_stations || [];
            const routes = data.top_routes || [];
            let html =
              '<div style="display: flex; flex-wrap: wrap; gap: 12px; justify-content: center;">';
            if (stations.length === 0) {
              html +=
                '<div style="color:#dc3545;">{% trans "No data available" %}.</div>';
            } else {
              stations.forEach((station) => {
                html += `<div style="background:#fff; border:1px solid #198754; border-radius:8px; padding:8px 10px; width:120px; min-width:120px; max-width:120px; text-align:center; margin-bottom:4px; display:flex; flex-direction:column; align-items:center; justify-content:center;">
                        <span style="font-weight:bold;">${station.name}</span><br>
                        <span style="font-size:12px; color:#888;">${station.line} | ${station.type}</span><br>
                        <span style="font-size:14px; color:#198754; font-weight:600; background:#e6f9ed; border-radius:5px; padding:2px 8px; margin-top:4px; display:inline-block;">${station.usage} {% trans "trips" %}</span>
                    </div>`;
              });
            }
            html += "</div>";
            // DBR04: Top similar routes
            html +=
              '<div class="mt-3 mb-1 fw-bold text-success" style="font-size:1rem; text-align:center;">{% trans "Most Used Routes" %}</div>';
            html +=
              '<div style="display: flex; flex-wrap: wrap; gap: 12px; justify-content: center;">';
            if (routes.length === 0) {
              html +=
                '<div style="color:#dc3545;">{% trans "No route data available" %}.</div>';
            } else {
              routes.forEach((route) => {
                const ruteStr =
                  route.rute && route.rute.length
                    ? route.rute.join(" &rarr; ")
                    : "";
                const criterionText = texts.criteria[route.criterion] || route.criterion;
                html += `<div style="background:#fff; border:1px solid #198754; border-radius:8px; padding:8px 10px; width:260px; min-width:260px; max-width:260px; text-align:center; margin-bottom:4px; display:flex; flex-direction:column; align-items:center; justify-content:center;">
                        <span style="font-weight:bold;">${route.start} → ${route.end}</span><br>
                        <span style="font-size:12px; color:#888;">${criterionText}</span><br>
                        <span style="font-size:13px; color:#198754; font-weight:600; background:#e6f9ed; border-radius:5px; padding:2px 8px; margin-top:4px; display:inline-block;">${route.count} {% trans "trips" %}</span>
                        <span style="font-size:11px; color:#198754; margin-top:6px; word-break:normal; white-space:pre-line;">${ruteStr}</span>
                    </div>`;
              });
            }
            html += "</div>";

            // Display recent routes
            const recentRoutes = data.recent_routes || [];
            html +=
              '<div class="mt-3 mb-1 fw-bold text-success" style="font-size:1rem; text-align:center;">{% trans "Most Recent Routes" %}</div>';
            html +=
              '<div style="display: flex; flex-wrap: wrap; gap: 12px; justify-content: center;">';
            if (recentRoutes.length === 0) {
              html +=
                '<div style="color:#dc3545;">{% trans "No recent routes" %}.</div>';
            } else {
              recentRoutes.forEach((route) => {
                const ruteStr =
                  route.rute && route.rute.length
                    ? route.rute.join(" &rarr; ")
                    : "";
                html += `<div style="background:#fff; border:1px solid #198754; border-radius:8px; padding:8px 10px; width:260px; min-width:260px; max-width:260px; text-align:center; margin-bottom:4px; display:flex; flex-direction:column; align-items:center; justify-content:center;">
                        <span style="font-weight:bold;">${route.start} → ${route.end}</span><br>
                        <span style="font-size:12px; color:#888;">${route.date}</span><br>
                        <span style="font-size:11px; color:#198754; margin-top:6px; word-break:normal; white-space:pre-line;">${ruteStr}</span>
                    </div>`;
              });
            }
            html += "</div>";
            
            document.getElementById("dashboard-stations").innerHTML = html;
          })
          .catch(() => {
            document.getElementById("dashboard-stations").innerHTML =
              '<div style="color:#dc3545;">{% trans "Error loading data" %}.</div>';
          });
      }

      document
        .querySelector('[data-bs-target="#offcanvasDashboard"]')
        .addEventListener("click", fetchDashboard);

      // Profile management functions
      function showProfileEditor() {
        document.getElementById('profileEditor').style.display = 'block';
        loadProfileData();
      }

      function hideProfileEditor() {
        document.getElementById('profileEditor').style.display = 'none';
      }

      function loadProfileData() {
        fetch('/auth/profile-data/')
          .then(response => response.json())
          .then(data => {
            if (data.metro_profile) {
              document.getElementById('profileName').value = data.metro_profile.name || '';
              document.getElementById('profilePerfil').value = data.metro_profile.perfil || 'Frecuente';
            }
          })
          .catch(error => {
            console.error('Error loading profile data:', error);
          });
      }

      // Handle profile form submission
      document.getElementById('profileForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        
        fetch('/auth/profile-data/', {
          method: 'POST',
          body: formData,
          headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // Show success message
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-success alert-dismissible fade show mt-3';
            alertDiv.innerHTML = `
              <i class="bi bi-check-circle me-2"></i>{% trans "Profile updated successfully" %}.
              <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.getElementById('profileEditor').appendChild(alertDiv);
            
            // Update profile display
            setTimeout(() => {
              location.reload(); // Reload to show updated profile data
            }, 1500);
          }
        })
        .catch(error => {
          console.error('Error updating profile:', error);
          const alertDiv = document.createElement('div');
          alertDiv.className = 'alert alert-danger alert-dismissible fade show mt-3';
          alertDiv.innerHTML = `
            <i class="bi bi-exclamation-triangle me-2"></i>{% trans "Error updating profile" %}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          `;
          document.getElementById('profileEditor').appendChild(alertDiv);
        });
      });
    </script>
  </body>
</html>
