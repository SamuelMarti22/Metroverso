{% load static %}
<!DOCTYPE html>
<html>
<head>


<meta charset="utf-8">
<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">

<!--MapBox imports-->
<link href="https://api.mapbox.com/mapbox-gl-js/v3.13.0/mapbox-gl.css" rel="stylesheet">
<script src="https://api.mapbox.com/mapbox-gl-js/v3.13.0/mapbox-gl.js"></script>

<!--CSS/style imports-->
<link rel="stylesheet" href="{% static 'css/mapStyle.css' %}">

<!--JS/js-->


</head>
<body>

<!--Map Container-->
<div id="map"></div>
<button id="btnLocation">Mi ubicación</button>

<!----->
<script>
mapboxgl.accessToken = 'pk.eyJ1IjoibGFjYXRyaWxmIiwiYSI6ImNtZG00eGJqZjAxMGYyaXBrcGY3b2tjYzIifQ.gx3C4J17a-6YrUBt6sZTmQ';

const initialLocationView = [-75.5752,6.2491]; // Coordinates of San Antonio

    const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/standard', // Style of the map
        config: {
            basemap: {
                theme: 'monochrome'
            }
        },
        center: initialLocationView,
        zoom: 15
    });

    // Variable global para almacenar el marcador del usuario
        let userMarker = null;
        let watchId = null;
        let lastUpdateTime = 0;
        const UPDATE_INTERVAL = 1000; // Intervalo de actualización en milisegundos

        // Función para obtener la ubicación del usuario
        function getUserLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function (position) {
                        updateUserLocation(position);
                        startLocationTracking();
                    },
                    handleLocationError,
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,           
                        maximumAge: 0           
                    }
                );
            }
        }

        // Función para actualizar la ubicación del usuario
        function updateUserLocation(position) {
            const userLat = position.coords.latitude;
            const userLng = position.coords.longitude;
            const accuracy = position.coords.accuracy;
            const currentTime = Date.now();

            // Limitar actualizaciones muy frecuentes
            if (currentTime - lastUpdateTime < UPDATE_INTERVAL) {
                return;
            }

            console.log("Location accuracy:", Math.round(accuracy * 100) / 100, "m");
            if (accuracy > 100) {
                console.warn("Precisión de ubicación baja");
                return;
            }

            lastUpdateTime = currentTime;

            if (!userMarker) {
                // Crear el marcador personalizado
                const markerElement = document.createElement('div');
                markerElement.innerHTML = '📍';
                markerElement.style.fontSize = '20px';
                markerElement.style.cursor = 'pointer';

                userMarker = new mapboxgl.Marker({ element: markerElement })
                    .setLngLat([userLng, userLat])
                    .setPopup(new mapboxgl.Popup().setText('Tu ubicación'))
                    .addTo(map);
            } else {
                // Si el marcador ya existe, solo actualizar su posición
                userMarker.setLngLat([userLng, userLat]);
            }
        }

        // Función para iniciar seguimiento optimizado
        function startLocationTracking() {
            watchId = navigator.geolocation.watchPosition(
                updateUserLocation,
                handleLocationError,
                {
                    enableHighAccuracy: true,
                    timeout: 5000,
                    maximumAge: UPDATE_INTERVAL
                }
            );
        }

        // Función para manejar errores de ubicación
        function handleLocationError(error) {
            console.warn('No se pudo obtener la ubicación:', error.message);

            switch (error.code) {
                case error.PERMISSION_DENIED:
                    console.warn('Permiso denegado para acceder a la ubicación.');
                    break;
                case error.POSITION_UNAVAILABLE:
                    console.warn('La información de ubicación no está disponible.');
                    break;
                case error.TIMEOUT:
                    console.warn('El tiempo de espera para obtener la ubicación expiró.');
                    break;
                default:
                    console.warn('Error al obtener la ubicación.');
                    break;
            }
        }

        // Función para detener el seguimiento
        function stopLocationTracking() {
            if (watchId !== null) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
        }

        // Pedir la ubicación cuando el mapa esté listo
        map.on('load', function () {
            getUserLocation();
        });

        document.getElementById('btnLocation').addEventListener('click', function () {
            if (userMarker) {
                map.flyTo({
                    center: userMarker.getLngLat(),
                    zoom: 15,
                    essential: true
                });
            } else {
                console.warn('No se ha podido encontrar la ubicación.');
            }
        });
</script>

</body>
</html>

