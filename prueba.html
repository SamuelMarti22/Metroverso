<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Mapa con ruta real Mapbox + D3</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.1.2/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.1.2/mapbox-gl.css" rel="stylesheet" />

    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }

        svg {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
        }

        circle {
            cursor: pointer;
        }

        /* Marcador en el centro */
        #marker {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 30px;
            height: 30px;
            background-image: url('https://cdn-icons-png.flaticon.com/512/684/684908.png');
            background-size: contain;
            background-repeat: no-repeat;
            transform: translate(-50%, -100%);
            /* para que la punta est√© justo en el centro */
            pointer-events: none;
            /* para que no bloquee el mapa */
        }

        button {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 10;
            background: white;
            padding: 8px;
            border-radius: 5px;
            cursor: pointer;
        }

        #btnEnd {
            position: absolute;
            top: 100px;
            left: 10px;
            z-index: 10;
            background: white;
            padding: 8px;
            border-radius: 5px;
            cursor: pointer;
        }

        .coord-display {
            font-size: 12px;
            margin-top: 5px;
            z-index: 20;
        }
    </style>
</head>

<body>

    <div id="map"></div>
    <div id="marker"></div> <!-- üî¥ El puntero fijo -->
    <button id="btnStart">üìç Capturar inicio</button>
    <button id="btnEnd">üéØ Capturar destino</button>
    <div class="coord-display" id="startDisplay">Inicio: -</div>
    <div class="coord-display" id="endDisplay">Destino: -</div>
    <script>

        function getGraph() {
            const metroData = {
                "type": "FeatureCollection",
                "features": [
                    {
                        "type": "Feature",
                        "properties": {},
                        "geometry": {
                            "coordinates": [
                                [
                                    -75.54427427251889,
                                    6.337857837532397
                                ],
                                [
                                    -75.54629793103578,
                                    6.337293264483492
                                ],
                                [
                                    -75.5472210033419,
                                    6.33678514821095
                                ],
                                [
                                    -75.54804466786128,
                                    6.336051201600839
                                ],
                                [
                                    -75.54867931063299,
                                    6.335180323885339
                                ],
                                [
                                    -75.5493093187473,
                                    6.334437967162856
                                ],
                                [
                                    -75.55169293985229,
                                    6.332372290077018
                                ],
                                [
                                    -75.55320624525959,
                                    6.330952135113378
                                ],
                                [
                                    -75.55372583569115,
                                    6.329970932904445
                                ]
                            ],
                            "type": "LineString"
                        }
                    },
                    {
                        "type": "Feature",
                        "properties": {
                            "L√≠nea": "A",
                            "Estaci√≥n": "Bello"
                        },
                        "geometry": {
                            "coordinates": [
                                -75.55373882545187,
                                6.329951567051836
                            ],
                            "type": "Point"
                        },
                        "id": 1
                    },
                    {
                        "type": "Feature",
                        "properties": {
                            "L√≠nea": "A",
                            "Estaci√≥n": "Niqu√≠a"
                        },
                        "geometry": {
                            "coordinates": [
                                -75.5442648269518,
                                6.337853604568238
                            ],
                            "type": "Point"
                        },
                        "id": 2
                    },
                    {
                        "type": "Feature",
                        "properties": {},
                        "geometry": {
                            "coordinates": [
                                [
                                    -75.55376127149324,
                                    6.329904525153168
                                ],
                                [
                                    -75.55478837104339,
                                    6.328063666670388
                                ],
                                [
                                    -75.55568918879699,
                                    6.322557784370687
                                ],
                                [
                                    -75.5556134191584,
                                    6.320633222991319
                                ],
                                [
                                    -75.55534401594021,
                                    6.315964035843791
                                ]
                            ],
                            "type": "LineString"
                        }
                    },
                    {
                        "type": "Feature",
                        "properties": {
                            "L√≠nea": "A"
                        },
                        "geometry": {
                            "coordinates": [
                                -75.55534849451645,
                                6.316008388898638
                            ],
                            "type": "Point"
                        },
                        "id": 4
                    },
                    {
                        "type": "Feature",
                        "properties": {},
                        "geometry": {
                            "coordinates": [
                                [
                                    -75.55535658129332,
                                    6.315992359767563
                                ],
                                [
                                    -75.55526778364677,
                                    6.3140827595606765
                                ],
                                [
                                    -75.5555906841794,
                                    6.31293539134397
                                ],
                                [
                                    -75.55650288144928,
                                    6.311539287833838
                                ],
                                [
                                    -75.55736664037404,
                                    6.310464126397818
                                ],
                                [
                                    -75.5577541210134,
                                    6.309445128051806
                                ],
                                [
                                    -75.55774604801272,
                                    6.308313793429932
                                ],
                                [
                                    -75.55726976972733,
                                    6.304719192744798
                                ],
                                [
                                    -75.55727784377994,
                                    6.3034915658861195
                                ],
                                [
                                    -75.55741507650619,
                                    6.3027854790083495
                                ],
                                [
                                    -75.55851293831701,
                                    6.299904955542104
                                ]
                            ],
                            "type": "LineString"
                        }
                    },
                    {
                        "type": "Feature",
                        "properties": {
                            "Linea": "A",
                            "Estaci√≥n": "Acevedo"
                        },
                        "geometry": {
                            "coordinates": [
                                -75.55849679307377,
                                6.299969148155711
                            ],
                            "type": "Point"
                        },
                        "id": 6
                    }
                ]
            }
            const graph = {};

            let startCoord = null;
            let endCoord = null;

            // 1Ô∏è‚É£ Tomar solo los puntos (estaciones)
            const stations = metroData.features.filter(f => f.geometry.type === "Point");

            // 2Ô∏è‚É£ Crear un mapa nombre ‚Üí coordenadas
            const stationCoords = {};
            stations.forEach(st => {
                stationCoords[st.properties.Estaci√≥n] = st.geometry.coordinates;
            });

            // 3Ô∏è‚É£ Procesar l√≠neas
            const lines = metroData.features.filter(f => f.geometry.type === "LineString");

            lines.forEach(line => {
                const coords = line.geometry.coordinates;

                // Tomar pares consecutivos de coordenadas
                for (let i = 0; i < coords.length - 1; i++) {
                    const a = coords[i];
                    const b = coords[i + 1];

                    // ¬øQu√© estaciones est√°n en esos puntos?
                    const stationA = Object.keys(stationCoords).find(name =>
                        stationCoords[name][0] === a[0] && stationCoords[name][1] === a[1]);

                    const stationB = Object.keys(stationCoords).find(name =>
                        stationCoords[name][0] === b[0] && stationCoords[name][1] === b[1]);

                    // Calcular distancia
                    const dist = d3.geoDistance(a, b) * 6371; // en km

                    // Inicializar en el grafo
                    if (!graph[stationA]) graph[stationA] = {};
                    if (!graph[stationB]) graph[stationB] = {};

                    // A√±adir aristas bidireccionales
                    graph[stationA][stationB] = dist;
                    graph[stationB][stationA] = dist;
                }
            });

            console.log(graph);

        }

        const metroData = {
            "type": "FeatureCollection",
            "features": [
                {
                    "type": "Feature",
                    "properties": {},
                    "geometry": {
                        "coordinates": [
                            [
                                -75.54427427251889,
                                6.337857837532397
                            ],
                            [
                                -75.54629793103578,
                                6.337293264483492
                            ],
                            [
                                -75.5472210033419,
                                6.33678514821095
                            ],
                            [
                                -75.54804466786128,
                                6.336051201600839
                            ],
                            [
                                -75.54867931063299,
                                6.335180323885339
                            ],
                            [
                                -75.5493093187473,
                                6.334437967162856
                            ],
                            [
                                -75.55169293985229,
                                6.332372290077018
                            ],
                            [
                                -75.55320624525959,
                                6.330952135113378
                            ],
                            [
                                -75.55372583569115,
                                6.329970932904445
                            ]
                        ],
                        "type": "LineString"
                    }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "L√≠nea": "A",
                        "Estaci√≥n": "Bello"
                    },
                    "geometry": {
                        "coordinates": [
                            -75.55373882545187,
                            6.329951567051836
                        ],
                        "type": "Point"
                    },
                    "id": 1
                },
                {
                    "type": "Feature",
                    "properties": {
                        "L√≠nea": "A",
                        "Estaci√≥n": "Niqu√≠a"
                    },
                    "geometry": {
                        "coordinates": [
                            -75.5442648269518,
                            6.337853604568238
                        ],
                        "type": "Point"
                    },
                    "id": 2
                },
                {
                    "type": "Feature",
                    "properties": {},
                    "geometry": {
                        "coordinates": [
                            [
                                -75.55376127149324,
                                6.329904525153168
                            ],
                            [
                                -75.55478837104339,
                                6.328063666670388
                            ],
                            [
                                -75.55568918879699,
                                6.322557784370687
                            ],
                            [
                                -75.5556134191584,
                                6.320633222991319
                            ],
                            [
                                -75.55534401594021,
                                6.315964035843791
                            ]
                        ],
                        "type": "LineString"
                    }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "L√≠nea": "A"
                    },
                    "geometry": {
                        "coordinates": [
                            -75.55534849451645,
                            6.316008388898638
                        ],
                        "type": "Point"
                    },
                    "id": 4
                },
                {
                    "type": "Feature",
                    "properties": {},
                    "geometry": {
                        "coordinates": [
                            [
                                -75.55535658129332,
                                6.315992359767563
                            ],
                            [
                                -75.55526778364677,
                                6.3140827595606765
                            ],
                            [
                                -75.5555906841794,
                                6.31293539134397
                            ],
                            [
                                -75.55650288144928,
                                6.311539287833838
                            ],
                            [
                                -75.55736664037404,
                                6.310464126397818
                            ],
                            [
                                -75.5577541210134,
                                6.309445128051806
                            ],
                            [
                                -75.55774604801272,
                                6.308313793429932
                            ],
                            [
                                -75.55726976972733,
                                6.304719192744798
                            ],
                            [
                                -75.55727784377994,
                                6.3034915658861195
                            ],
                            [
                                -75.55741507650619,
                                6.3027854790083495
                            ],
                            [
                                -75.55851293831701,
                                6.299904955542104
                            ]
                        ],
                        "type": "LineString"
                    }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "Linea": "A",
                        "Estaci√≥n": "Acevedo"
                    },
                    "geometry": {
                        "coordinates": [
                            -75.55849679307377,
                            6.299969148155711
                        ],
                        "type": "Point"
                    },
                    "id": 6
                }
            ]
        }
        // üëâ Coloca aqu√≠ tu token de Mapbox
        mapboxgl.accessToken = "pk.eyJ1IjoibGFjYXRyaWxmIiwiYSI6ImNtZG00eGJqZjAxMGYyaXBrcGY3b2tjYzIifQ.gx3C4J17a-6YrUBt6sZTmQ";

        // 1Ô∏è‚É£ Crear el mapa centrado en Medell√≠n
        const map = new mapboxgl.Map({
            container: 'map',
            // Choose from Mapbox's core styles, or make your own style with Mapbox Studio
            style: 'mapbox://styles/mapbox/standard',
            config: {
                basemap: {
                    theme: 'monochrome'
                }
            },
            center: [-75.563591, 6.251840],
            zoom: 15
        });

        // 3Ô∏è‚É£ Crear SVG sobre el mapa
        const container = map.getCanvasContainer();
        const svg = d3.select(container).append("svg")
            .attr("width", window.innerWidth)
            .attr("height", window.innerHeight);


        const lines = metroData.features.filter(f => f.geometry.type === "LineString");
        const stations = metroData.features.filter(f => f.geometry.type === "Point");

        const linePaths = svg.selectAll("path.metro-line")
            .data(lines)
            .enter()
            .append("path")
            .attr("class", "metro-line")
            .attr("fill", "none")
            .attr("stroke", "#007AFF")
            .attr("stroke-width", 4)
            .attr("opacity", 0.8);

        // 4Ô∏è‚É£ Dibujar los puntos
        const stationCircles = svg.selectAll("circle.station")
            .data(stations)
            .enter()
            .append("circle")
            .attr("class", "station")
            .attr("r", 5);

        // 7Ô∏è‚É£ (Opcional) Dibujar nombres de estaciones
        const stationLabels = svg.selectAll("text")
            .data(stations)
            .enter()
            .append("text")
            .text(d => d.properties.Estaci√≥n || "")
            .attr("dy", -8); // subir texto un poquito

        // 5Ô∏è‚É£ Funci√≥n para actualizar la posici√≥n de los puntos
        function updatePoints() {
            circles
                .attr("cx", d => map.project(d.coords).x)
                .attr("cy", d => map.project(d.coords).y);
        }

        // 8Ô∏è‚É£ Funci√≥n para actualizar las posiciones (cada render del mapa)
        function updateMap() {
            // L√≠neas
            linePaths.attr("d", d => {
                const proj = d.geometry.coordinates.map(coord => map.project(coord));
                return d3.line()
                    .x(p => p.x)
                    .y(p => p.y)
                    .curve(d3.curveLinear)(proj);
            });

            // Estaciones (c√≠rculos)
            stationCircles
                .attr("cx", d => map.project(d.geometry.coordinates).x)
                .attr("cy", d => map.project(d.geometry.coordinates).y);

            // Labels
            stationLabels
                .attr("x", d => map.project(d.geometry.coordinates).x)
                .attr("y", d => map.project(d.geometry.coordinates).y);
        }

        document.getElementById("btnStart").addEventListener("click", () => {
            const center = map.getCenter();
            startCoord = [center.lng, center.lat];
            document.getElementById("startDisplay").textContent = `Inicio: ${startCoord[0].toFixed(5)}, ${startCoord[1].toFixed(5)}`;
            console.log("üìç Coordenada de inicio:", startCoord);
        });

        // üéØ Bot√≥n para capturar destino
        document.getElementById("btnEnd").addEventListener("click", () => {
            const center = map.getCenter();
            endCoord = [center.lng, center.lat];
            document.getElementById("endDisplay").textContent = `Destino: ${endCoord[0].toFixed(5)}, ${endCoord[1].toFixed(5)}`;
            console.log("üéØ Coordenada de destino:", endCoord);
        });

        // 9Ô∏è‚É£ Llamamos updateMap cada vez que el mapa hace render
        map.on("render", updateMap);
    </script>

</body>

</html>